# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an Ansible Galaxy collection (`homelab.common_roles`) containing reusable Ansible roles for homelab infrastructure management. The collection focuses on system configuration tasks such as package manager proxying through Nexus and user management.

## Repository Structure

```
ansible-common-roles/
├── roles/                      # Individual Ansible roles
│   ├── apt_nexus_mirror/      # Configure APT to use Nexus mirror (Debian/Ubuntu)
│   ├── pip_nexus_mirror/      # Configure pip to use Nexus PyPI proxy
│   ├── dockerhub_nexus_mirror/# Configure Docker to use Nexus registry mirror
│   ├── disable_user/          # Lock user accounts and disable SSH access
│   └── set_hostname/          # Set system hostname
├── galaxy.yml                 # Ansible Galaxy collection metadata
└── meta/runtime.yml          # Collection runtime requirements
```

## Role Architecture

Each role follows standard Ansible role structure:
- `tasks/main.y*ml` - Main task list
- `defaults/main.y*ml` - Default variables (user-overridable)
- `handlers/main.y*ml` - Event handlers (when present)
- `meta/main.y*ml` - Role metadata including supported platforms

### Nexus Mirror Roles Pattern

The three Nexus mirror roles (`apt_nexus_mirror`, `pip_nexus_mirror`, `dockerhub_nexus_mirror`) follow a consistent pattern:
- Configure package managers to use a Nexus repository (default: `nexus.knighten.io`)
- Store configuration in system-level files (`/etc/apt/sources.list`, `/etc/pip.conf`, `/etc/docker/daemon.json`)
- Use `become: true` for privilege escalation
- The `apt_nexus_mirror` role conditionally handles both Ubuntu (Jammy) and Debian (Bookworm) with distribution-specific source lists
- All Nexus URLs are configurable via role variables with `*_nexus_base_url` pattern

### Variable Naming Convention

Role variables are prefixed with the role name to avoid conflicts:
- Configuration variables: `<role>_nexus_base_url` (e.g., `apt_nexus_mirror_nexus_base_url`)
- Other variables: `<role>_<variable>` (e.g., `disable_user_name`, `set_hostname_hostname`)
- All Nexus mirror roles support overriding the base URL to point to custom Nexus servers

## Development Commands

### Python Environment Setup
```bash
# Install uv (if not already installed)
pip install uv

# Sync dependencies from pyproject.toml
uv sync

# Activate the virtual environment (automatically created by uv)
source .venv/bin/activate
```

### Linting
```bash
# Lint all roles
ansible-lint roles

# Lint specific role
ansible-lint roles/apt_nexus_mirror
```

### Development Workflow
```bash
# Run commands via uv (without activating venv)
uv run ansible-lint roles

# Add new dependencies
# Edit pyproject.toml, then run:
uv sync
```

### Git Workflow
This repository uses conventional commits:
- Commit format: `type(scope): description` (e.g., `feat: created role to set hostname`, `fix: updated nexus URLs for debian`)
- Conventional commit types:
  - `feat:` - New features (minor version bump)
  - `fix:` - Bug fixes (patch version bump)
  - `docs:` - Documentation changes
  - `build:` - Build system changes
  - `ci:` - CI/CD changes
  - `BREAKING CHANGE:` - Breaking changes (major version bump)

## Release Process

Releases are fully automated using a reusable GitHub Actions workflow:
- **Trigger**: Push to `main` branch (excluding CHANGELOG.md changes)
- **Workflow**: Uses `Knighten-Homelab/gha-reusable-workflows/.github/workflows/semantic-release-to-gh.yaml@main`
- **Configuration**: Semantic-release configuration is generated by the reusable workflow
- **Output**: Creates GitHub releases and updates CHANGELOG.md automatically
- **Version Format**: Uses `${version}` tag format (no 'v' prefix)
- **Commit Message**: Release commits are formatted as `RELEASE: ${nextRelease.version}`

The conventional commit types determine version bumps:
- `feat:` → minor version bump
- `fix:` → patch version bump
- `BREAKING CHANGE:` → major version bump

### Local Release Testing
To test release notes generation locally without publishing:
```bash
# Not available - use the reusable workflow for all releases
# All semantic-release configuration is centralized in the workflow
```

## Collection Metadata

- **Namespace**: `homelab`
- **Name**: `common_roles`
- **Minimum Ansible Version**: 2.17.0
- **License**: Apache-2.0
- **Repository**: https://github.com/Johnny-Knighten/ansible-homelab-common-roles

## File Extension Conventions

The codebase uses both `.yml` and `.yaml` extensions inconsistently. When creating new files, match the extension used in the same role. Most roles use `.yaml` for tasks/defaults, while some use `.yml` for meta/handlers.
